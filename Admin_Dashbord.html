<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة التحكم - Dashboard</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <style>
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #mainContent {
      flex-grow: 1;
      display: none; /* مخفي لحد التحقق */
    }
    #usersSection {
      display: none;
      margin: 20px auto;
      max-width: 900px;
    }
  </style>
</head>
<body>

<div id="mainContent">

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">لوحة التحكم</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" 
        aria-controls="navbarContent" aria-expanded="false" aria-label="تبديل التنقل">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="./admin-products.html" id="linkProducts">المنتجات</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="./admin-categories.html" id="linkCategories">الأقسام</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="./admin-orders.html"> الأوردرات</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="linkUsers">الادمنز</a>
          </li>
       <li class="nav-item">
  <a class="nav-link" href="./User_Product.html" id="linkUsers">معاينة كالمستخدم</a>
</li>
        </ul>

        <div class="d-flex">
          <button id="btnLogin" class="btn btn-outline-light me-2">تسجيل الدخول</button>
          <button id="btnLogout" class="btn btn-light d-none">تسجيل الخروج</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container my-5 text-center" id="dashboardSection">
    <h1 class="mb-4">مرحباً بك في لوحة التحكم</h1>
    <p>يمكنك التحكم في المنتجات والأقسام من خلال الأزرار أعلاه.</p>
  </div>

  <!-- Users Management Section -->
  <div id="usersSection" class="container">
    <h2 class="mb-4 text-center">إدارة الادمنز - Admin Users</h2>

    <div class="card mb-4">
      <div class="card-header">إضافة أدمن جديد</div>
      <div class="card-body">
        <form id="addAdminForm" class="row g-3">
          <div class="col-md-4">
            <input type="text" class="form-control form-control-lg" id="adminName" placeholder="الاسم الكامل" required autocomplete="name" />
          </div>
          <div class="col-md-4">
            <input type="email" class="form-control form-control-lg" id="adminEmail" placeholder="البريد الإلكتروني" required autocomplete="email" />
          </div>
          <div class="col-md-4">
            <input type="password" class="form-control form-control-lg" id="adminPassword" placeholder="كلمة المرور (6 أحرف على الأقل)" minlength="6" required autocomplete="new-password" />
          </div>
          <div class="col-12 text-center mt-3">
            <button type="submit" class="btn btn-success btn-lg px-5">إضافة أدمن</button>
          </div>
        </form>

        <div id="addAdminMessage" class="mt-3 text-center"></div>
      </div>
    </div>

    <table class="table table-striped text-center" id="adminsTable">
      <thead>
        <tr>
          <th>الاسم</th>
          <th>البريد الإلكتروني</th>
          <th>الإجراء</th>
        </tr>
      </thead>
      <tbody>
        <!-- هنا يتم تحميل الأدمنز -->
      </tbody>
    </table>
  </div>

</div>

<!-- Bootstrap JS Bundle (يشمل Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
  import { auth, database } from '/firebase-config.js';
  import { onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { ref as dbRef, set, get, remove } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

  const mainContent = document.getElementById('mainContent');
  const btnLogin = document.getElementById('btnLogin');
  const btnLogout = document.getElementById('btnLogout');

  // أقسام المحتوى
  const dashboardSection = document.getElementById('dashboardSection');
  const usersSection = document.getElementById('usersSection');

  // روابط النافبار
  const linkProducts = document.getElementById('linkProducts');
  const linkCategories = document.getElementById('linkCategories');
  const linkUsers = document.getElementById('linkUsers');

  // إدارة المستخدمين
  const adminsTableBody = document.querySelector('#adminsTable tbody');
  const addAdminForm = document.getElementById('addAdminForm');
  const addAdminMessage = document.getElementById('addAdminMessage');

  // لنحفظ مؤقتًا بيانات المستخدم الأصلي
  let originalUserEmail = null;

  // لتحديث أزرار الدخول والخروج
  function updateButtons(isLoggedIn) {
    if (isLoggedIn) {
      btnLogin.classList.add('d-none');
      btnLogout.classList.remove('d-none');
    } else {
      btnLogin.classList.remove('d-none');
      btnLogout.classList.add('d-none');
    }
  }

  function redirectToLogin() {
    window.location.href = './login/login.html';
  }

  function showSection(section) {
    dashboardSection.style.display = 'none';
    usersSection.style.display = 'none';

    if (section === 'dashboard') {
      dashboardSection.style.display = 'block';
    } else if (section === 'users') {
      usersSection.style.display = 'block';
      loadAdmins();
    }
  }

  // تحميل الأدمنز من Firebase
  async function loadAdmins() {
    adminsTableBody.innerHTML = '';
    try {
      const snapshot = await get(dbRef(database, 'users'));
      if (snapshot.exists()) {
        const users = snapshot.val();
        for (const uid in users) {
          if (users[uid].type === 'admin') {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${users[uid].name || '-'}</td>
              <td>${users[uid].email || '-'}</td>
              <td>
                <button class="btn btn-danger btn-sm btn-delete" data-uid="${uid}">حذف</button>
              </td>`;
            adminsTableBody.appendChild(tr);
          }
        }
      }
    } catch (err) {
      console.error('Error loading admins:', err);
    }
  }

  // إضافة أدمن جديد
  addAdminForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    addAdminMessage.textContent = '';
    addAdminMessage.className = '';

    const name = document.getElementById('adminName').value.trim();
    const email = document.getElementById('adminEmail').value.trim();
    const password = document.getElementById('adminPassword').value;

    if (!name || !email || !password) {
      addAdminMessage.textContent = 'يرجى ملء جميع الحقول.';
      addAdminMessage.className = 'text-danger';
      return;
    }

    if (password.length < 6) {
      addAdminMessage.textContent = 'كلمة المرور يجب أن تكون 6 أحرف على الأقل.';
      addAdminMessage.className = 'text-danger';
      return;
    }

    try {
      // 1. نسجل الايميل الحالي عشان نقدر نرجع له بعد التبديل
      if (!originalUserEmail && auth.currentUser) {
        originalUserEmail = auth.currentUser.email;
      }

      // 2. نضيف المستخدم الجديد (هذا سيؤدي لتغيير حالة تسجيل الدخول)
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;

      // 3. نحفظ بيانات الأدمن الجديد في الداتابيز
      await set(dbRef(database, 'users/' + user.uid), {
        name: name,
        email: email,
        type: 'admin'
      });

      addAdminMessage.textContent = 'تم إضافة الأدمن بنجاح!';
      addAdminMessage.className = 'text-success';
      addAdminForm.reset();
      loadAdmins();

      

      // 5. نطلب من المستخدم الأصلي أن يعيد تسجيل الدخول (لا يمكن تلقائيًا لعدم حفظ الباسورد)
      alert('تم إضافة الأدمن الجديد. يرجى تسجيل الدخول مرة أخرى.');

      // redirectToLogin();

    } catch (error) {
      addAdminMessage.textContent = 'حدث خطأ: ' + error.message;
      addAdminMessage.className = 'text-danger';
    }
  });

  // حذف أدمن
  adminsTableBody.addEventListener('click', async (e) => {
    if (e.target.classList.contains('btn-delete')) {
      const uid = e.target.getAttribute('data-uid');
      if (confirm('هل أنت متأكد من حذف هذا الأدمن؟')) {
        try {
          await remove(dbRef(database, 'users/' + uid));
          // ملاحظة: حذف المستخدم من Auth يتطلب استخدام Admin SDK أو Cloud Functions وهذا غير متاح من الكلاينت

          loadAdmins();
          alert('تم حذف الأدمن.');
        } catch (error) {
          alert('حدث خطأ أثناء الحذف: ' + error.message);
        }
      }
    }
  });

  // روابط النافبار
  linkProducts.addEventListener('click', (e) => {
    // تفتح صفحة المنتجات كما هي
  });

  linkCategories.addEventListener('click', (e) => {
    // تفتح صفحة الأقسام كما هي
  });

  linkUsers.addEventListener('click', (e) => {
    e.preventDefault();
    showSection('users');
  });

  // التحقق من حالة تسجيل الدخول وصلاحية الأدمن
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      updateButtons(false);
      mainContent.style.display = 'none';
      redirectToLogin();
      return;
    }
    try {
      const userSnap = await get(dbRef(database, 'users/' + user.uid));
      const ud = userSnap.exists() ? userSnap.val() : null;
      if (!ud || ud.type !== 'admin') {
        alert('ليس لديك صلاحية الوصول.');
        await signOut(auth);
        updateButtons(false);
        mainContent.style.display = 'none';
        redirectToLogin();
        return;
      }
      updateButtons(true);
      mainContent.style.display = 'block';
      showSection('dashboard'); // عرض الصفحة الرئيسية عند الدخول
    } catch (error) {
      console.error(error);
      alert('حدث خطأ في التحقق من المستخدم.');
      updateButtons(false);
      mainContent.style.display = 'none';
      redirectToLogin();
    }
  });

  // تسجيل الخروج
  btnLogout.addEventListener('click', async () => {
    try {
      await signOut(auth);
      updateButtons(false);
      mainContent.style.display = 'none';
      alert('تم تسجيل الخروج');
      redirectToLogin();
    } catch (error) {
      console.error('Logout error:', error);
      alert('حدث خطأ أثناء تسجيل الخروج.');
    }
  });

  // زر تسجيل الدخول (يمكن استخدامه إن أردت)
  btnLogin.addEventListener('click', () => {
    window.location.href = './login/login.html';
  });
</script>

</body>
</html>
