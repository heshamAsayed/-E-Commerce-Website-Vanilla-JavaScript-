<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <title>عربة التسوق - متجري</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="lightMode.css">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: 'Tajawal', sans-serif;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* Animated background particles */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
      animation: float 20s ease-in-out infinite;
      z-index: -1;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0px) rotate(0deg);
      }

      50% {
        transform: translateY(-20px) rotate(180deg);
      }
    }

    .container {
      position: relative;
      z-index: 10;
    }

    /* Header Section */
    .cart-header {
      background: var(--bg-color);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px var(--box-shadow);
      border: 1px solid var(--border-color);
      animation: slideInDown 0.8s ease-out;
    }

    .cart-header h1 {
      color: #2d3748;
      font-weight: 700;
      font-size: 2.5rem;
      text-align: center;
      margin-bottom: 10px;
    }

    .cart-header .subtitle {
      color: var(--text-color-sec);
      text-align: center;
      font-size: 1.1rem;
    }

    /* Cart Table */
    .cart-table-container {
      background: var(--bg-color);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px var(--box-shadow);
      border: 1px solidvar(--border-color);
      animation: fadeInUp 0.8s ease-out 0.2s both;
    }

    .table {
      margin-bottom: 0;
    }

    .table thead th {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: var(--main-text-color);
      border: none;
      padding: 15px;
      font-weight: 600;
      text-align: center;
    }

    .table tbody td {
      padding: 15px;
      vertical-align: middle;
      border-color: rgba(0, 0, 0, 0.05);
    }

    .table tbody tr {
      transition: all 0.3s ease;
    }

    .table tbody tr:hover {
      background: rgba(102, 126, 234, 0.05);
      transform: scale(1.01);
    }

    /* Product Image */
    .product-img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 10px;
      box-shadow: 0 4px 8px var(--box-shadow);
    }

    /* Quantity Controls */
    .quantity-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .quantity-btn {
      width: 35px;
      height: 35px;
      border: none;
      border-radius: 50%;
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: var(--main-text-color);
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .quantity-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }

    .quantity-display {
      font-weight: 600;
      color: #2d3748;
      min-width: 30px;
      text-align: center;
    }

    /* Delete Button */
    .btn-delete {
      background: linear-gradient(45deg, #e53e3e, #f56565);
      border: none;
      border-radius: 8px;
      padding: 8px 15px;
      color: var(--main-text-color);
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-delete:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(229, 62, 62, 0.3);
    }

    /* Total Section */
    .total-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      padding: 25px;
      margin: 30px 0;
      box-shadow: 0 10px 30px var(--box-shadow);
      border: 1px solidvar(--border-color);
      animation: fadeInUp 0.8s ease-out 0.4s both;
    }

    .total-amount {
      font-size: 2rem;
      font-weight: 700;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Action Buttons */
    .action-buttons {
      text-align: center;
      margin-top: 30px;
      animation: fadeInUp 0.8s ease-out 0.6s both;
    }

    .btn-primary {
      background: linear-gradient(45deg, #667eea, #764ba2);
      border: none;
      border-radius: 12px;
      padding: 15px 40px;
      font-weight: 600;
      font-size: 1.1rem;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      overflow: hidden;
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, var(--border-color), transparent);
      transition: left 0.5s;
    }

    .btn-primary:hover::before {
      left: 100%;
    }

    .btn-primary:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(45deg, #718096, #a0aec0);
      border: none;
      border-radius: 12px;
      padding: 15px 40px;
      font-weight: 600;
      font-size: 1.1rem;
      transition: all 0.3s ease;
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(113, 128, 150, 0.3);
    }

    /* Empty Cart */
    .empty-cart {
      text-align: center;
      padding: 60px 20px;
      color: #718096;
      background-color: var(--bg-color-sec);
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }

    .empty-cart i {
      font-size: 4rem;
      color: var(--text-color);
      margin-bottom: 20px;
    }

    .table tbody tr:hover {
      overflow: hidden !important;

    }

    /* Message Area */
    .message-area {
      margin-top: 20px;
    }

    .alert {
      border-radius: 12px;
      border: none;
      padding: 15px 20px;
      font-weight: 600;
    }

    .alert-success {
      background: linear-gradient(45deg, #48bb78, #38a169);
      color: var(--main-text-color);
    }

    .alert-danger {
      background: linear-gradient(45deg, #e53e3e, #f56565);
      color: var(--main-text-color);
    }

    .alert-warning {
      background: linear-gradient(45deg, #ed8936, #f6ad55);
      color: var(--main-text-color);
    }

    /* Loading Animation */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--loading-color);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .cart-header h1 {
        font-size: 2rem;
      }

      .table-responsive {
        border-radius: 15px;
      }

      .quantity-controls {
        flex-direction: column;
        gap: 5px;
      }
    }

  </style>

  <link rel="stylesheet" href="ModeChange.css">

</head>

<body>

  <div class="container my-5">
    <!-- Cart Header -->
    <div class="cart-header">
      <h1><i class="fas fa-shopping-cart me-3"></i>عربة التسوق</h1>
      <p class="subtitle">راجع منتجاتك وأكمل عملية الشراء</p>
    </div>

    <!-- Cart Table -->
    <div class="cart-table-container">
      <div class="table-responsive  overflow-hidden">
        <table class="table" id="cartTable">
          <thead>
            <tr>
              <th>المنتج</th>
              <th>السعر</th>
              <th>الكمية</th>
              <th>الإجمالي</th>
              <th>الإجراءات</th>
            </tr>
          </thead>
          <tbody>
            <!-- تظهر هنا -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Total Section -->
    <div class="total-section text-center">
      <h3>الإجمالي الكلي: <span class="total-amount" id="totalPrice">0</span> جنيه</h3>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="btn btn-primary btn-lg me-3" id="btnPlaceOrder">
        <i class="fas fa-paper-plane me-2"></i>إرسال الطلب
      </button>
      <a href="./User_Product.html" class="btn btn-secondary btn-lg">
        <i class="fas fa-arrow-right me-2"></i>العودة للمنتجات
      </a>
    </div>

    <!-- Message Area -->
    <div id="messageArea" class="message-area"></div>
  </div>






  <script type="module">
    import { auth, database } from './firebase-config.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { ref as dbRef, push, set, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    const cartTableBody = document.querySelector('#cartTable tbody');
    const totalPriceEl = document.getElementById('totalPrice');
    const btnPlaceOrder = document.getElementById('btnPlaceOrder');
    const messageArea = document.getElementById('messageArea');

    function renderCart() {
      let cart = JSON.parse(localStorage.getItem('cart')) || {};

      cartTableBody.innerHTML = '';

      let total = 0;

      if (Object.keys(cart).length === 0) {
        cartTableBody.innerHTML = `
        <tr>
          <td colspan="5">
            <div class="empty-cart animate__animated animate__fadeIn">
              <i class="fas fa-shopping-cart"></i>
              <h4>العربة فارغة</h4>
              <p>لم تقم بإضافة أي منتجات للعربة بعد</p>
              <a href="./User_Product.html" class="btn btn-primary">
                <i class="fas fa-shopping-bag me-2"></i>تسوق الآن
              </a>
            </div>
          </td>
        </tr>
      `;
        btnPlaceOrder.disabled = true;
        return;
      }

      for (const id in cart) {
        const item = cart[id];
        console.log(item)
        const itemTotal = item.price * item.quantity;
        total += itemTotal;

        const tr = document.createElement('tr');
        tr.className = 'animate__animated animate__fadeInUp';
        tr.innerHTML = `
        <td>
          <div class="d-flex align-items-center">
            <img src="${item.imageURL || 'https://via.placeholder.com/60x60?text=Product'}" 
                 class="product-img me-3" alt="${item.name}">
            <div>
              <h6 class="mb-0 fw-bold">${item.name}</h6>
              <small class="text-muted">#${id}</small>
            </div>
          </div>
        </td>
        <td class="fw-bold text-primary">${item.price.toFixed(2)} جنيه</td>
        <td>
          <div class="quantity-controls">
            <button class="quantity-btn" onclick="updateQuantity('${id}', -1)">-</button>
            <span class="quantity-display">${item.quantity}</span>
            <button class="quantity-btn" onclick="updateQuantity('${id}', 1)">+</button>
          </div>
        </td>
        <td class="fw-bold text-success">${itemTotal.toFixed(2)} جنيه</td>
        <td>
          <button class="btn btn-delete" onclick="removeItem('${id}')">
            <i class="fas fa-trash me-1"></i>حذف
          </button>
        </td>
      `;
        cartTableBody.appendChild(tr);
      }

      totalPriceEl.textContent = total.toFixed(2);
      btnPlaceOrder.disabled = false;
    }

    // Global functions for quantity controls
    window.updateQuantity = function (id, change) {
      let cart = JSON.parse(localStorage.getItem('cart')) || {};
      if (cart[id]) {
        cart[id].quantity += change;
        if (cart[id].quantity <= 0) {
          delete cart[id];
        }
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCart();
      }
    };

    window.removeItem = function (id) {
      let cart = JSON.parse(localStorage.getItem('cart')) || {};
      delete cart[id];
      localStorage.setItem('cart', JSON.stringify(cart));
      renderCart();
      showMessage('تم حذف المنتج من العربة', 'success');
    };

    async function getUserName(uid) {
      try {
        const snapshot = await get(dbRef(database, 'users/' + uid));
        if (snapshot.exists()) {
          return snapshot.val().name || null;
        }
        return null;
      } catch (error) {
        console.error('خطأ في جلب اسم المستخدم:', error);
        return null;
      }
    }

    function showMessage(text, type = "success") {
      messageArea.innerHTML = `
      <div class="alert alert-${type} animate__animated animate__fadeInUp" role="alert">
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
        ${text}
      </div>
    `;
      setTimeout(() => {
        messageArea.innerHTML = "";
      }, 4000);
    }

    btnPlaceOrder.addEventListener('click', () => {
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          showMessage("يجب تسجيل الدخول لإرسال الطلب", "danger");
          setTimeout(() => {
            window.location.href = './login/login.html';
          }, 2000);
          return;
        }

        let cart = JSON.parse(localStorage.getItem('cart'));
        if (!cart || Object.keys(cart).length === 0) {
          showMessage("العربة فارغة", "warning");
          return;
        }

        const userName = await getUserName(user.uid) || user.email;
        const orderRef = push(dbRef(database, 'orders'));
        const orderData = {
          userId: user.uid,
          userName: userName,
          userEmail: user.email,
          products: cart,
          totalPrice: Object.values(cart).reduce((sum, item) => sum + item.price * item.quantity, 0),
          status: "pending",
          orderDate: new Date().toISOString()
        };

        // تعطيل الزر وإضافة مؤشر تحميل
        btnPlaceOrder.disabled = true;
        btnPlaceOrder.innerHTML = `
        <span class="loading-spinner me-2"></span>
        جاري الإرسال...
      `;

        try {
          await set(orderRef, orderData);
          localStorage.removeItem('cart');
          renderCart();
          showMessage("تم إرسال الطلب بنجاح! 🎉", "success");

          // Redirect after success
          setTimeout(() => {
            window.location.href = './User_Product.html';
          }, 3000);
        } catch (error) {
          showMessage("حدث خطأ أثناء إرسال الطلب: " + error.message, "danger");
        } finally {
          // إعادة الزر لحالته الأصلية
          btnPlaceOrder.disabled = false;
          btnPlaceOrder.innerHTML = '<i class="fas fa-paper-plane me-2"></i>إرسال الطلب';
        }
      });
    });


    renderCart();



  </script>

  <button class="btn btn-info" id="btn-theme" onclick="changeTheme()">🌙</button>
  <script src="theme.js"></script>

</body>

</html>